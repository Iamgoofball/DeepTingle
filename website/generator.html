<!DOCTYPE html>
<html>
<style>
    .demo-card-wide {
      width: 100%;
      padding: 10px;
      margin: auto;  

    }
    
    mark{
        background: orange;
        color: black;
    }
    
    body{
        background-color:beige;
        padding:10px;
    }
    
    #p1main {
        padding-top:10px;
        margin-right: auto;
        margin-left: auto;
         text-align: center;
    }
    
    #maindiv{
        width: 80%;
          margin-left:auto;
        margin-right:auto;
        text-align: center;
        display:none;
    }
    
    #descriptioncard {
        color:#fff;
        width: 100%;
    }

    .mdl-card__title.mdl-card--colored {
         text-align: center;
        margin-left:auto;
        margin-right:auto;
    }
    
    #cellleft {
        width:65%;
    }
    
    #cellright {
        width:20%;
    }
    
    
    #mlinputText {
        width:70%;
    }
    
    
    #tingleright {
      color: #fff;
      background:
        url('dino-1-fulldream.jpg') center / cover no-repeat  ;
      height: 500px;
    }
    
    .content-grid {
        margin-left: auto;
        margin-right: auto;
        padding:10px;
        width:70%;
    }
    
    p {
        color:black;
    }
</style>
    
<head>
    <title>DeepTingle</title>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0">
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <link rel="stylesheet" href="https://code.getmdl.io/1.3.0/material.deep_purple-pink.min.css" /> 
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:regular,bold,italic,thin,light,bolditalic,black,medium&amp;lang=en">
    <link rel="stylesheet" href="dropdown.css">
</head>
    
<body>
    <div class="mdl-layout mdl-js-layout mdl-layout--fixed-header">
        <header class="mdl-layout__header mdl-layout__header--waterfall portfolio-header">
            <div class="mdl-layout__header-row portfolio-logo-row">
                <span class="mdl-layout__title">
                    <div class="portfolio-logo"></div>
                    <a class="mdl-navigation__link" href="index.html"><span class="mdl-layout__title"><i class="material-icons">menu</i>Deep Tingle</span></a>
                </span>
            </div>
            <div class="mdl-layout__header-row portfolio-navigation-row mdl-layout--large-screen-only">
                <nav class="mdl-navigation mdl-typography--body-1-force-preferred-font">
                    <a class="mdl-navigation__link" href="predictor.html">Predictive Tingle</a>
                    <a class="mdl-navigation__link  is-active" href="translator.html">Tingle Translator</a>
                    <a class="mdl-navigation__link  is-active" href="generator.html">Classic Tingles</a>
                    <a class="mdl-navigation__link" href="about.html">About</a>
                </nav>
            </div>
        </header>
        <div class="mdl-layout__drawer mdl-layout--small-screen-only">
            <nav class="mdl-navigation mdl-typography--body-1-force-preferred-font">
                <a class="mdl-navigation__link is-active" href="predictor.html">Predictive Tingle</a>
                <a class="mdl-navigation__link" href="translator.html">Tingle Translator</a>
                <a class="mdl-navigation__link  is-active" href="generator.html">Classic Tingles</a>
                <a class="mdl-navigation__link" href="about.html">About</a>
            </nav>
        </div>
        
        <!---------------------------------------------------------------->
        
        <main class="mdl-layout__content">
            <div id="p1main">
                <div id="p1" class="mdl-spinner mdl-spinner--single-color mdl-js-spinner is-active"></div>
            </div>
            
            <div id="maindiv">
                <div class="demo-card-wide mdl-card mdl-card--border mdl-shadow--3dp mdl-card--colored" id="descriptioncard">
                <!--div id="description"-->
                    <div class="mdl-card__title mdl-card--colored">
                        <h2 class="mdl-card__title-text">Classic Tingles</h2>
                    </div>
                    <p>Generate text based on the first lines of famous novels!</p>
                    <div class="content-grid mdl-grid">
                        <div class="mdl-cell">
                            <label class="mdl-select__label">Book:</label>
                        </div>
                        <div class="mdl-cell">
                            <div class="mdl-select mdl-js-select mdl-select--floating-label" style="width:inherited">
                                <select id="booknames" name="titles">
                                  <!--option value="option1">option 1</option-->
                                </select>
                            </div>
                        </div>

                        
                    </div>
                    
                    <div >
                         <div id="tinglefydiv">
                            <button class="mdl-button mdl-js-button mdl-button--raised mdl-js-ripple-effect mdl-button--colored"  onclick="return createText()" id="tinglefy" >Generate!</button>
                        </div>
                        <br><br>
                        <p id="originalline" style="color:black;font:italic 12px Georgia,serif"></p>
                    </div>
                    <br>
                    
                    <div id="checkdiv" style="text-align:center">
                        <label id="check" class="mdl-switch mdl-js-switch" for="substitutionCbx" style="width:25%;magin:auto">
                            <input type="checkbox" id="substitutionCbx" class="mdl-switch__input" checked>
                            <span class="mdl-switch__label" style="color:black;font:10px">Substitution on/off</span>
                        </label>
                         <div class="mdl-tooltip" for="substitutionCbx">Use the words which appear 100 times more in Tingle text than in Wikipedia.</div>
                    </div>
                    <br><br>
                    <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label" style="width:25%;margin:auto">
                        <input class="mdl-textfield__input" type="text" pattern="-?([1-9]?|[[1-9]?([0-9])?|[1-5]?[0-9]?([0-9])?)?" id="amountInput" style="color:black" value="50">
                        <label class="mdl-textfield__label" for="amountInput">Amount of words to be generated.</label>
                        <span class="mdl-textfield__error">Input must be number larger than 0 and smaller than 600!</span>
                    </div>

                    
                    <!--/div-->
                    
                </div>
                <div id="bar" class="mdl-progress mdl-js-progress" style="width:100%"></div>
                
                <form>
                    <div class="mdl-textfield mdl-js-textfield" id="mlinputText">
                        <textarea class="mdl-textfield__input" type="text" rows= "10" id="inputText"  style="widht:80%"></textarea>
                        <label class="mdl-textfield__label" for="inputText">Tingled text:</label>
                    </div>
                </form>

                <div class="demo-card-wide mdl-card mdl-card--border mdl-shadow--3dp mdl-card--colored" id="tingleright"> </div>
           </div> 
        </main>
    </div>
   
    <script src="https://code.getmdl.io/1.3.0/material.min.js"></script>
</body>
<script src="dist/keras.js"></script>

<script>
    var inputText ="?";
    var SUBSTITUTE_ONLY_IF_FIRST_CHAR_MATCH = false;
    var INPUT_SIZE = 5;
    var AMOUNT = 50;
    var dicReady = false;
    var modelReady = false;
    var reverseDic = {};
    var dic = {};
    
    function hidetop(arr) {
        document.getElementById('descriptioncard').style.display='none';
    }
    
    function cleanInput(input) {
        var modifiedString = input.substring(0);
        modifiedString = modifiedString.toLowerCase();
        modifiedString = modifiedString.replace(/\t/g, " ");
        modifiedString = modifiedString.replace(/\n/g, " ");
        modifiedString = modifiedString.replace(/!/g, " . ");
        modifiedString = modifiedString.replace(/"/g, " ");
        modifiedString = modifiedString.replace(/#/g, " "); 
        modifiedString = modifiedString.replace(/'/g, "'"); 
        modifiedString = modifiedString.replace(/\(/g, " "); 
        modifiedString = modifiedString.replace(/\)/g, " "); 
        modifiedString = modifiedString.replace(/,/g, " , ");
        modifiedString = modifiedString.replace(/-/g, " "); 
        modifiedString = modifiedString.replace(/\./g, " . "); 
        modifiedString = modifiedString.replace(/\//g, " ");
        modifiedString = modifiedString.replace(/:/g, " ");
        modifiedString = modifiedString.replace(/;/g, " ; "); 
        modifiedString = modifiedString.replace(/\?/g, " ? ");
        modifiedString = modifiedString.replace(/–/g, " ");
        modifiedString = modifiedString.replace(/—/g, " ");
        modifiedString = modifiedString.replace(/‘/g, "'"); 
        modifiedString = modifiedString.replace(/…/g, " . ");
        modifiedString = modifiedString.replace(/ç/g, "c");
        modifiedString = modifiedString.replace(/é/g, "e");
        modifiedString = modifiedString.trim();
        var newString = modifiedString.replace(/  /g," ");
        while(!(newString === modifiedString)) {
            modifiedString = newString;
            newString = modifiedString.replace(/  /g," ");
        }
            
        return modifiedString;
    }
    
    var varValue = 0;
    
    document.querySelector('#bar').addEventListener('mdl-componentupgraded', function() {
            console.log(varValue);
            this.MaterialProgress.setProgress(varValue);
            });
    
    function updateBar(value) {
        var event = new Event('mdl-componentupgraded');
        varValue = value;
        if(varValue > 100)
            varValue = 100;
        
        document.querySelector('#bar').dispatchEvent(event);
        
          }
    
    function resetBar() {
        varValue = 0;
        var event = new Event('mdl-componentupgraded');
        document.querySelector('#bar').dispatchEvent(event);
     }
    
    //https://gist.github.com/andrei-m/982927
    function levenshtein(a, b) {
      if (a.length === 0) return b.length;
      if (b.length === 0) return a.length;
      let tmp, i, j, prev, val, row;
      // swap to save some memory O(min(a,b)) instead of O(a)
      if (a.length > b.length) {
        tmp = a;
        a = b;
        b = tmp;
      }

      row = Array(a.length + 1)
      // init the row
      for (i = 0; i <= a.length; i++) {
        row[i] = i;
      }

      // fill in the rest
      for (i = 1; i <= b.length; i++) {
        prev = i;
        for (j = 1; j <= a.length; j++) {
          if (b[i - 1] === a[j - 1]) {
            val = row[j - 1]; // match
          } else {
            val = Math.min(row[j - 1] + 1, // substitution
                  Math.min(prev + 1,     // insertion
                           row[j] + 1));  // deletion
          }
          row[j - 1] = prev;
          prev = val;
        }
        row[a.length] = prev;
      }
      return row[a.length];
    }
    
    /*
    Substitute a word for the closest one in the dictionary
    */
    function substitute(word) {
        //console.log(dic);
        console.log(word+" _ "+dic[word]);
        if(dic[word] === undefined && word.charAt(0) != '*') {
            //var key = Object.keys(dic);
            var closestWord = null;
            var distance = 9999999;
            var str="";
            for(var key in dic) {
                var dist = levenshtein(word,key);
                if((SUBSTITUTE_ONLY_IF_FIRST_CHAR_MATCH && key.charAt(0) === word.charAt(0)) || !SUBSTITUTE_ONLY_IF_FIRST_CHAR_MATCH
                   || closestWord === null){
                    if(dist < distance || closestWord === null) {
                        closestWord = key;
                        distance = dist;
                    }
                }
                //str += key + " "+levenshtein(word,key)+"\n";
            }
            return closestWord;
            //console.log(str);
        } else {
            return word;
        }
    }
    
    function updateLine(event) {
        console.log(event);//document.getElementById('booknames').text);
        if (!event) {
            event = window.event; 
        };

        //console.log(event.srcElement.innerHTML);
        var word;
        if(event.srElement)
            word = event.srcElement.innerHTML;
        else
            word = event.target.textContent;
        console.log(word);
        return false;
    }
    
    var finishedRun = true;
    var text;
    var counter;
    var remadeText = null;
    var percentage = 0;
    function createText() {
        var seed = "";
        continueRunning = true;
        document.querySelector('#bar').addEventListener('mdl-componentupgraded', function() {
            this.MaterialProgress.setProgress(varValue);
            });
        resetBar();
        var booknames = document.getElementById('booknames');
        for(var c in booknames.children) {
            //console.log(booknames.children[c].value)
            if(booknames.children[c].selected) {
                seed = booknames.children[c].value;
                break;
            }
        }
        
        if(document.getElementById("check").classList.contains('is-checked'))
            useSub = true;
        else
            useSub = false;
        
        document.getElementById("originalline").innerHTML = "\""+seed+"\"";
        AMOUNT = document.getElementById("amountInput").value;
        counter = 0;
        if(AMOUNT < 10)
            percentage = 0;
        else
            percentage = Math.floor(AMOUNT/10.0);
        
        if(seed ==="")
            return false;
        
        if(useSub) {
            var split = cleanInput(seed).split(" ");
            for(var i = 0; i < split.length ;i++) {
                var newWord = substitute(split[i]);
                split[i] = newWord;
            }

            seed = remakeText(split);
        }
        
        finishedRun = false;
        setTimer();
        seed = generate(seed);
        
        return false;
    }
    
    var useSub = true;
    var continueRunning = true;
    function runAgain() {
        console.log("Running "+counter);
        if(counter >= AMOUNT) {
            updateBar(100);
            continueRunning = false;
            return false;
        } else {
            finishedRun = false;
            setTimer();
            var seed = document.getElementById('inputText').value;
            generate(seed);

            return false;
        }
    }
    
    function generate(seed) {
        console.log(counter);
        
        if(counter%percentage == 0) {
            updateBar(10+counter/percentage*10);
            
        }
        if(counter >= AMOUNT){
            updateBar(100);
            continueRunning = false;
            return false;
        }
        
        counter++;
        remadeText = null;
        text = cleanInput(seed).split(" ");
        var data = [0, 0, 0, 0, 0];  
        INPUT_SIZE = 5;
        
        last = 0;
        for(i = 0; i < data.length; i++) {
            data[last] = 0;
            last++
        }
        
        if(text.length < INPUT_SIZE) {
                
            last = data.length-1;
            for(i = text.length - 1; i >= 0 && last >= 0; i--) {
                if(dic[text[i]] === undefined)
                    continue;//data[last] = 0;
                else
                    data[last] = dic[text[i]];
                last--;
            }
        } else {
            var last = data.length-1;
            //console.log("--------------");
            for(i = text.length - 1; i >=0 && last >= 0; i--) {
                //console.log(splitted[i]);
                if(dic[text[i]] === undefined)
                    if(useSub)
                        data[last] = 0;
                    else
                        continue;//data[last] = 0;
                else
                    data[last] = dic[text[i]];
               // console.log(i +" "+ dic[splitted[i]] +" "+splitted[i]+" last="+last);
                last--;
                //console.log(data);

            }
        }
        console.log(data);

        
        const inputData = {
            'input': new Float32Array(data)
        };



        //console.log(inputData);
        model.predict(inputData).then(outputData => {
            var str = 
                offerSugestion(outputData,1);
            
        }).catch(err => {
            console.log(err);
        });
    }
    
    function offerSugestion(outputData, quant) {
        //deleting first one
        var index = getMaxIndex(outputData.output);
        var word = reverseDic[index];
        
        var str = remakeText(text) + " "+word;
        console.log(str);
        document.getElementById('inputText').value = str;
        finishedRun = true;
        return str;
        
    }
    
    function setTimer(){
        setTimeout(function(){
            if(finishedRun && continueRunning){
                runAgain();
            }
            setTimer();
        }, 1000);
    };
    
    function remakeText(text) {
        //if(counter == 0)
            remadeText = caps(text[0]);
       // else
          //  remadeText = text[0];
        
        var nextCaps = false;
        for(var i = 1; i < text.length; i++) {
            if(text[i] == '?' || text[i] == '.') {
                //if(counter == 0)
                    nextCaps = true;
                    remadeText += text[i];
                //else
                 //   remadeText+=text[i];
            } else if(text[i] == ',') {
                remadeText+=text[i];
            } else {
                if(nextCaps) {
                    nextCaps = false;
                    remadeText += " "+(caps(text[i]));
                } else
                    remadeText += " "+text[i];
            }
        }
        return remadeText;
    }
    
    
    function caps(word) {
        if(word.length == 0)
            return word;
        if(word.length == 1)
            return word.toUpperCase();
        return word[0].toUpperCase().charAt(0)+word.toLowerCase().substring(1);
    }
    
    function getMaxIndex(arr){
        var maxValue = arr[0];
        var maxIndex = 0;
        for(var i=1; i<arr.length; i++){
            if(arr[i] > maxValue){
                maxValue = arr[i];
                maxIndex = i;
            }
        }
        return maxIndex;
    }
    
    function getMaxIndexes(arr, quant){
        var indexes = new Float32Array(quant);
        var maxValue = arr[0];
        var maxIndex = 0;
        var lowerValue = 1234561234;
        var indexLower = -1;
        for(var i = 0; i < quant+1;i++) {
            indexes[i] = i;
            if(lowerValue > arr[i]) {
                lowerValue = arr[i];
                indexLower = i;
            }
        }
        for(var i=quant; i<arr.length; i++) {
            if(arr[i] > lowerValue) {
                indexes[indexLower] = i;
                
                lowerValue = arr[indexes[0]];
                indexLower = 0;
                for(var j =1; j < quant; j++) {
                    if(arr[indexes[j]] < lowerValue) {
                        lowerValue = arr[indexes[j]];
                        indexLower = j;
                    }
                }
                
            }
            
            
        }
        
        return indexes;
    }
    
    
    var client = new XMLHttpRequest();
    
    //Number -> Word
    client.open('GET', 'Gabb_Data/wordsDic.txt');
    client.onreadystatechange = function() {
        var lines = client.responseText.split('\n');
        for (var i=0; i<lines.length; i++){
            var l = lines[i].split(" ");
            if(l.length > 1){
                reverseDic[parseInt(l[0])] = l[1].trim();
                dic[l[1].trim()] = parseInt(l[0]);
            }
        }
        dicReady = true;
        console.log("Dictionary Ready");
    }
    
    const model = new KerasJS.Model({
        filepaths: {
            model: 'newmodel/model.json',
            weights: 'newmodel/model_weights.buf',
            metadata: 'newmodel/model_metadata.json'
        },
        gpu: true
    });
    
    client.send();
    
    model.ready().then(() => {
        modelReady = true;
        console.log("Model Ready");
        document.getElementById('maindiv').style.display='block';
        document.getElementById('p1').style.display='none';
    }).catch(err => {
        console.log(err);
    });
    
    
   function loadJSON(callback) {
        var xobj = new XMLHttpRequest();
            xobj.overrideMimeType("application/json");
        xobj.open('GET', 'Gabb_Data/firstline.json', true); // Replace 'my_data' with the path to your file
        xobj.onreadystatechange = function () {
              if (xobj.readyState == 4 && xobj.status == "200") {
                // Required use of an anonymous callback as .open will NOT return a value but simply returns undefined in asynchronous mode
                callback(xobj.responseText);
              }
        };
        xobj.send(null);  
    }
 
    var books;
    
    function loadBooks() {
        loadJSON(function(response) {
            // Parse JSON string into object
            books = JSON.parse(response);
            console.log(books);
            
            var l = books.books[0].line;
            console.log(l);
           // <!--option value="option1">option 1</option-->
            //id = booknames
            
            // <!--option value="option1">option 1</option-->
            //id = booknames
            for(var i = 0; i < books.books.length; i++) {
                var op = document.createElement('option');
                op.value = books.books[i].line;
                op.text = books.books[i].book;
                document.getElementById('booknames').appendChild(op);
            }
            
        });
        
        
    }
    loadBooks();
    
    
    
</script>
</html>
